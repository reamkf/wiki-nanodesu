name: Deploy Next.js site to GitHub Pages

on:
  push:
    branches: ["main"]
    paths-ignore:
      - "README.md"
      - "LICENSE.md"
      - ".vscode/*"
      - ".cursor/*"
      - ".cursorignore"
      - "gas/*"
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  prepare:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: ".bun-version"

      - name: Restore node_modules cache
        uses: actions/cache@v5
        with:
          path: node_modules
          key: ${{ runner.os }}-bun-modules-${{ hashFiles('**/bun.lock') }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

  build:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: ".bun-version"

      - name: Setup Pages
        uses: actions/configure-pages@v5
        with:
          static_site_generator: next

      - name: Restore node_modules cache
        uses: actions/cache@v5
        with:
          path: node_modules
          key: ${{ runner.os }}-bun-modules-${{ hashFiles('**/bun.lock') }}

      - name: Restore Next.js cache
        uses: actions/cache@v5
        with:
          path: |
            .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/bun.lock') }}-${{ hashFiles('**.[jt]s', '**.[jt]sx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/bun.lock') }}-

      - name: Build with Next.js
        run: bun --bun run build

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: ./out

  lint:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: ".bun-version"

      - name: Restore node_modules cache
        uses: actions/cache@v5
        with:
          path: node_modules
          key: ${{ runner.os }}-bun-modules-${{ hashFiles('**/bun.lock') }}

      - name: Run lint
        run: bun --bun run lint

  test:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: ".bun-version"

      - name: Restore node_modules cache
        uses: actions/cache@v5
        with:
          path: node_modules
          key: ${{ runner.os }}-bun-modules-${{ hashFiles('**/bun.lock') }}

      - name: Run tests
        run: bun --bun run test

  test-e2e:
    runs-on: ubuntu-latest
    needs: [prepare]
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: ".bun-version"

      - name: Restore node_modules cache
        uses: actions/cache@v5
        with:
          path: node_modules
          key: ${{ runner.os }}-bun-modules-${{ hashFiles('**/bun.lock') }}

      - name: Install Playwright browsers
        run: bunx playwright install --with-deps

      - name: Build with Next.js
        run: bun --bun run build

      - name: Run E2E tests
        run: bun run test:e2e

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: [build, lint, test, test-e2e]
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  notify:
    runs-on: ubuntu-latest
    needs: [build, lint, test, test-e2e, deploy]
    if: always()
    steps:
      - name: Notify Discord
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          BUILD_STATUS: ${{ needs.build.result }}
          LINT_STATUS: ${{ needs.lint.result }}
          TEST_STATUS: ${{ needs.test.result }}
          E2E_STATUS: ${{ needs.test-e2e.result }}
          DEPLOY_STATUS: ${{ needs.deploy.result }}
        run: |
          repo_url="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY"
          run_url="$repo_url/actions/runs/$GITHUB_RUN_ID"
          commit_url="$repo_url/commit/$GITHUB_SHA"
          short_sha=$(echo "$GITHUB_SHA" | cut -c1-7)
          actor_url="$GITHUB_SERVER_URL/$GITHUB_ACTOR"
          actor_icon="https://github.com/${GITHUB_ACTOR}.png?size=64"
          ref_url="$repo_url/tree/$GITHUB_REF_NAME"
          owner=${GITHUB_REPOSITORY%%/*}
          repo=${GITHUB_REPOSITORY##*/}
          page_url="https://${owner}.github.io/${repo}/"

          if [ "$BUILD_STATUS" = "success" ] && [ "$DEPLOY_STATUS" = "success" ]; then
            color=3066993
            title="✅ wiki-nanodesu deployment success"
            status_description="Build and deployment completed successfully"
          elif [ "$BUILD_STATUS" = "failure" ]; then
            color=15158332
            title="❌ wiki-nanodesu build failed"
            status_description="Build failed. Deployment was skipped."
          elif [ "$LINT_STATUS" = "failure" ]; then
            color=15158332
            title="❌ wiki-nanodesu lint failed"
            status_description="Lint failed. Deployment was skipped."
          elif [ "$TEST_STATUS" = "failure" ]; then
            color=15158332
            title="❌ wiki-nanodesu test failed"
            status_description="Unit test failed. Deployment was skipped."
          elif [ "$E2E_STATUS" = "failure" ]; then
            color=15158332
            title="❌ wiki-nanodesu E2E test failed"
            status_description="E2E test failed. Deployment was skipped."
          elif [ "$DEPLOY_STATUS" = "failure" ]; then
            color=15158332
            title="❌ wiki-nanodesu deployment failed"
            status_description="Build succeeded but deployment failed."
          elif [ "$BUILD_STATUS" = "cancelled" ] || [ "$DEPLOY_STATUS" = "cancelled" ] || [ "$LINT_STATUS" = "cancelled" ] || [ "$TEST_STATUS" = "cancelled" ] || [ "$E2E_STATUS" = "cancelled" ]; then
            color=15105570
            title="⚠️ wiki-nanodesu workflow cancelled"
            status_description="Workflow was cancelled."
          else
            color=15105570
            title="⚠️ wiki-nanodesu workflow ${BUILD_STATUS:-unknown}"
            status_description="Build: ${BUILD_STATUS}, Lint: ${LINT_STATUS}, Test: ${TEST_STATUS}, E2E: ${E2E_STATUS}, Deploy: ${DEPLOY_STATUS}"
          fi
          payload=$(cat <<EOF
          {
            "username": "GitHub",
            "avatar_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
            "embeds": [
              {
                "title": "${title}",
                "description": "${status_description}",
                "url": "${run_url}",
                "color": ${color},
                "author": {
                  "name": "${GITHUB_ACTOR}",
                  "url": "${actor_url}",
                  "icon_url": "${actor_icon}"
                },
                "fields": [
                  {"name":"Repository","value":"[${GITHUB_REPOSITORY}](${repo_url})","inline":true},
                  {"name":"Build Status","value":"${BUILD_STATUS}","inline":true},
                  {"name":"Lint Status","value":"${LINT_STATUS}","inline":true},
                  {"name":"Test Status","value":"${TEST_STATUS}","inline":true},
                  {"name":"E2E Status","value":"${E2E_STATUS}","inline":true},
                  {"name":"Deploy Status","value":"${DEPLOY_STATUS}","inline":true},
                  {"name":"Pages URL","value":"${page_url}","inline":false},
                  {"name":"Ref","value":"[${GITHUB_REF_NAME}](${ref_url})","inline":true},
                  {"name":"Commit","value":"[\`${short_sha}\`](${commit_url})","inline":true},
                  {"name":"Actor","value":"[${GITHUB_ACTOR}](${actor_url})","inline":true}
                ],
                "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
              }
            ]
          }
          EOF
          )
          curl -H "Content-Type: application/json" -X POST -d "$payload" "$WEBHOOK_URL"
